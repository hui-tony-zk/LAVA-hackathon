---
title: "Final_Analysis.Rmd"
author: "Tony Hui"
date: "October 24, 2015"
output: 
  html_document: 
    keep_md: yes
    self_contained: no
    toc: yes
---

# Prelimary analysis of the Data

## Load dependencies

```{r}
require(knitr)
opts_chunk$set(echo=F)
```

```{r warning=FALSE, error=FALSE}
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(stringr))
suppressPackageStartupMessages(require(tidyr))
suppressPackageStartupMessages(require(data.table))
suppressPackageStartupMessages(require(ggplot2))
```

## Load data

```{r}
files <- dir(path = "ObservationFiles/")

read_files <- function(x) {
  filename <- x
  file_metadata_info <- str_split_fixed(gsub(".csv", "", filename), pattern = "-", n = 4) %>% 
    c() %>% 
    str_replace(pattern = "Course|Instr|Semester|Observation", replacement = "")
  
  file <- read.csv(paste0("ObservationFiles/", x))
  colnames(file)[1] <- "time" # first column is time, but it is unlabeled
  file <- file[1:length(levels(file$time))-1,]
  file$time <- 1:nrow(file) *2
  if (ncol(file) > 26) {
    file <- file %>% select(-starts_with("X")) # some columns have a shit-tonne of extra columns, presumably due to excel export error...
  }
  file$course <- file_metadata_info[1]
  file$instructor <- file_metadata_info[2]
  file$semester <- file_metadata_info[3]
  file$observation <- file_metadata_info[4]
  file$year <- substr(file$course, start = 1, stop = 1)
  return(file)
}

all_files <- lapply(files, read_files)
names(all_files) <- files
```

### Sneak peak at the data

```{r}
lapply(all_files, ncol) %>% unlist %>% unique()
lapply(all_files, nrow) %>% unlist %>% unique() %>% sort()
```

Number of rows/columns all over the place - assume that there should only be 26 "real" columns (plus the 4 columns of metadata that was added) - use this function to figure out what's wrong.

```{r eval=FALSE}
(outliers_column <- all_files[lapply(all_files, ncol) == 31] %>% names)
read.csv(paste0("ObservationFiles/", outliers_column[1])) %>% colnames

(outliers_row <- all_files[lapply(all_files, nrow) == 49] %>% names)
read.csv(paste0("ObservationFiles/", outliers_row[1])) %>% View
```

### Issue fixed - went back and fixed the read file function and combined all data

```{r}
all_files_clean <- rbindlist(all_files) %>% as.data.frame()
all_files_clean[is.na(all_files_clean)] <- 0
all_files_clean %>% head() %>% kable(format = "markdown")
```

### Merge in class performance levels

#### Read in the file

```{r}
class_perform <- read.csv("StudentPerformance.csv") %>%
  separate(ClassSection, into = c("course", "instructor", "semester"), sep = "-") 
  

class_perform$course <- str_replace(class_perform$course, pattern = "Course", replacement = "")
class_perform$instructor <- str_replace(class_perform$instructor, pattern = "Instr", replacement = "")
class_perform$semester <- str_replace(class_perform$semester, pattern = "Semester", replacement = "")

class_perform %>% head() %>% kable(format = "markdown")
```

#### Merge with the rest

```{r}
all_files_clean_marks <- full_join(all_files_clean, class_perform)
write.csv(x = all_files_clean_marks, file = "all_observations_cleaned.csv", quote = F, row.names = F)
```

## Fractional amount of time spent on each category overall

```{r}
gathered_values <- all_files_clean %>% 
  tbl_df() %>%
  select(-time) %>%
  gather(key = measure, value = value, -(course:year), na.rm = T)

gathered_values %>% 
  group_by(measure) %>%
  summarize(total_time = sum(value)/n()) %>%
  ggplot(aes(y = total_time, x = reorder(measure, total_time)))+
  geom_point() + 
  xlab("Activitiy") + 
  coord_flip() +
  theme_bw()
```

## Fractional amount of time spent on each category overall per year

```{r}
gathered_values %>% 
  group_by(year, measure) %>%
  summarize(total_time = sum(value)/n()) %>%
  ggplot(aes(y = total_time, x = reorder(measure, total_time), group = year, color = year))+
  geom_point() + 
  geom_line() +
  xlab("Activitiy") + 
  # facet_wrap(~ year, nrow = 1) + 
  coord_flip() +
  theme_bw()
```

## Fractional amount of time spent on each category for all courses in 1st year, further granuarized by instructor

The labels in each box represents the course

```{r}
gathered_values %>% 
  filter(year == 1) %>%
  group_by(course, instructor, measure) %>%
  summarize(total_time = sum(value)/n()) %>%
  ggplot(aes(y = total_time, x = reorder(measure, total_time), color = instructor, group = instructor))+
  geom_line() + 
  xlab("Activitiy") + 
  facet_wrap(~ course, nrow = 1) + 
  coord_flip() +
  theme_bw()
```

# Question 1: fraction of time spent on activities versus growth (student performance)

## Time spent on lecture vs student growth

All courses - each dot is one course (separated by year level)

```{r student_perf_vs_lecture_time}
student_perf_vs_lecture_time <- all_files_clean_marks %>%
  group_by(course, instructor, semester) %>%
  summarize(
    num_obs = n(),
    num_lecture = sum(Instructor.Lecturing, na.rm = T),
    student_performance = mean(StudentPerformance.SectionAverage)
  ) %>%
  mutate(percent_time = num_lecture / num_obs, course_level = paste0("year", substr(course, start = 1, stop = 1)))

student_perf_vs_lecture_time %>%
  ggplot(aes(x = student_performance, y = percent_time)) +
    facet_wrap(~ course_level) + 
    geom_point() +
    geom_smooth(method = "lm", se = F) +
    ylab("Fraction of time spent on lecturing") +
    xlab("Gain in student performance")
```

Looks like there's a positive correlation with lecture time and student performance in first year classes, and a negative correlation in second year classes

# Question 2: Quantifying transitions in class "states"

Looking only at 

## Time spent on lecture vs student growth



